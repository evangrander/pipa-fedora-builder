Name: Build install package

permissions:
  contents: write

on:
  # Runs once a month (1st day of the month at midnight UTC)
  schedule:
    - cron: "0 0 1 * *"
  # Runs whenever you manually click the "Run workflow" button
  workflow_dispatch:
  # Runs when changes are pushed to main (except for documentation/metadata)
  push:
    branches:
      - 'main'
    paths-ignore:
      - '.gitignore'
      - 'LICENSE'
      - '*.md'

jobs:
  build:
    # IMPORTANT: Assumes this is running on your self-hosted ARM device (e.g., Xiaomi Pad 6)
    runs-on: ubuntu-24.04-arm

    steps:
    - uses: actions/checkout@v3

    - name: Build the Docker image
      run: docker build . -t 'pipa-fedora-builder'

    - name: Build Fedora Rawhide (KDE) Image
      # HARDCODED: Set variables to force Rawhide and KDE Plasma.
      # FEDORA_VERSION='42' targets the current Rawhide development branch.
      run: |
        docker run --privileged \
          -e FEDORA_VERSION="42" \
          -e DESKTOP_ENV="kde" \
          -v "$(pwd)"/images:/build/images \
          -v "/dev:/dev" \
          pipa-fedora-builder

    - name: Get current date and short commit hash
      id: date_hash
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT && echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        # Dynamic tag for clean nightly builds
        tag_name: rawhide-kde-f42-${{ steps.date_hash.outputs.date }}-${{ steps.date_hash.outputs.hash }}
        name: Fedora 42 Rawhide (KDE) - ${{ steps.date_hash.outputs.date }}
        files: images/*.zip
        draft: true
