Name: Build install package

permissions:
  contents: write

on:
  # Runs once a month for a fresh build
  schedule:
    - cron: "0 0 1 * *"
  # Allows manual triggering with a single click from the GitHub UI
  workflow_dispatch:
  # Runs when changes are pushed to main
  push:
    branches:
      - 'main'
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '*.md'

jobs:
  build:
    # Target the self-hosted ARM runner
    runs-on: ubuntu-24.04-arm

    steps:
    - uses: actions/checkout@v3

    - name: Build the Docker image
      run: docker build . -t 'pipa-fedora-builder'

    - name: Build Fedora 43 (KDE Plasma) Image
      # CRITICAL: Adding DNF_OPTS to skip broken pipewire plugin
      run: |
        docker run --privileged \
          -e FEDORA_VERSION="43" \
          -e DESKTOP_ENV="kde" \
          -e DNF_OPTS="--skip-broken --nobest" \
          -v "$(pwd)"/images:/build/images \
          -v "/dev:/dev" \
          pipa-fedora-builder

    - name: Get current date and short commit hash
      id: date_hash
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT && echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: fedora-43-kde-${{ steps.date_hash.outputs.date }}-${{ steps.date_hash.outputs.hash }}
        name: Fedora 43 (KDE Plasma) Build - ${{ steps.date_hash.outputs.date }}
        files: images/*.zip
        draft: true
